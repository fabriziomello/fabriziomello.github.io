---
layout: post
title: "Case PgBouncer 1.3 com PostgreSQL 8.2"
date: 2009-07-03
comments: false
categories:
 - postgresql
---

<div class='post'>
Pessoal,<br /><br />Estou finalizando a implantação do <a href="https://developer.skype.com/SkypeGarage/DbProjects/PgBouncer">PgBouncer</a><a href="https://developer.skype.com/SkypeGarage/DbProjects/PgBouncer"> 1.3</a> com <a href="http://www.postgresql.org/docs/8.2/interactive/index.html">PostgreSQL 8.2</a> e obtive excelentes resultados só pelo fato de colocar o Pool de Conexões na frente do "postmaster".<br /><br />Até aqui não temos nada de muito surpreendente a não ser pelo fato de que, segundo a documentação do próprio <a href="https://developer.skype.com/SkypeGarage/DbProjects/PgBouncer">PgBouncer</a> fala que podemos ter 100% de transparência com o <a href="http://www.postgresql.org/docs/8.3/interactive/index.html">PostgreSQL 8.3</a> pelo fato do comando "<a href="http://www.postgresql.org/docs/8.3/interactive/sql-discard.html">DISCARD</a>" estar presente apartir dessa release.<br /><br />Como na versão que estamos utilizando, a 8.2, não existe essa implementação então o jeito foi implementar uma PL que "emule" o comportamento do "<a href="http://www.postgresql.org/docs/8.3/interactive/sql-discard.html">DISCARD</a>".<br /><br />Através da lista de discussão da Comunidade Brasileira de PostgreSQL (<a href="https://listas.postgresql.org.br/cgi-bin/mailman/listinfo/pgbr-geral">pgbr-geral)</a>, com a ajuda do colega <a href="http://www.timbira.com/">Euler</a>, implementei uma PL para suprir essa falta conforme segue:<br /><pre><br /><span style=";font-family:courier new;font-size:78%;"  >create or replace function fc_discard_all() returns void as<br />$$<br />declare<br />  rComando record;<br />  iVersao  integer;<br />begin<br /><br />  select cast(setting as integer) <br />    into iVersao<br />    from pg_settings <br />   where name ~ 'server_version_num';<br /><br />  if not found then<br />    raise exception 'A versão do PostgreSQL deve ser >= 8.2';<br />  end if;<br /><br />  if iVersao >= 80300 then<br />    execute 'discard all';<br />    return;<br />  end if;<br /><br />  set session authorization default;<br /><br />  reset all;<br /><br />  for rComando in <br />    select name <br />      from pg_prepared_statements<br />  loop<br />    execute 'deallocate '||rComando.name;<br />  end loop;<br /><br />  for rComando in<br />    select name<br />      from pg_cursors<br />     where name not like '%unnamed%' <br />  loop<br />    execute 'close '||rComando.name;<br />  end loop;<br /><br />  unlisten *;<br /><br />  perform pg_advisory_unlock_all();<br /><br />  for rComando in<br />    select distinct<br />           table_schema,<br />           table_name<br />      from information_schema.tables <br />     where table_type = 'LOCAL TEMPORARY'<br />  loop<br />    execute 'drop table if exists '||quote_ident(rComando.table_schema)||'.'||quote_ident(rComando.table_name)||' cascade';<br />  end loop;<br /><br />  return;<br />end;<br />$$<br />language plpgsql;<br /></span><br /></pre>No meu arquivo de configuração do pool (pgbouncer.ini) fiz o seguinte:<br /><br />server_reset_query = SELECT fc_discard_all()<br /><br /><br />Os únicos efeitos colaterais dessa solução são:<br /><ol><li>Se a base de dados que for acessada não tiver a PL acima criada vai gerar um log de erro, mas não impacta em problemas na conexão</li><li>Não foi possível implementar uma emulação para o DISCARD PLANS pois, segundo o colega <a href="http://www.timbira.com">Euler</a>, esse comando <a href="http://listas.postgresql.org.br/pipermail/pgbr-geral/2009-June/015926.html">veio em conjunto com a funcionalidade de invalidação de planos em funções procedurais, logo não pode ser emulada em versões menores que 8.3</a><br /></li></ol>Tive de implementar esse recurso pois preciso descartar tabelas temporárias e outros recursos que são utilizados pela minha aplicação.<br /><br />O modo do pool que estou utilizando é o "session" pois preciso da sessão do inicio ao fim com o mesmo estado.<br /><br />Se alguém tiver alguma dica e/ou critica estou a disposição.<br /><br /><br />Cordialmente,<br /><br />Fabrízio de Royes Mello<br />fabriziomello [at] gmail.com</div>
